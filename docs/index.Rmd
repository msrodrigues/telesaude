---
title: "Telesaúde - Operação Inverno"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)

# Bibliotecas -------------------------------------------------------------
library(pacman)

# Georreferenciamento e mapas
p_load(ggmap)
p_load(sp)
p_load(rgdal)
p_load(hereR)
p_load(geobr)

# Tabelas, Ferramentas estatísticas,
p_load(directlabels)
p_load(esquisse)
p_load(obAnalytics)
p_load(DescTools)
p_load(kableExtra)
p_load(RColorBrewer)
p_load(scales)
p_load(reactable)
p_load(htmlwidgets)
p_load(highcharter)
p_load(leaflet)
p_load(htmltools)

# Data wrangling
p_load(collapse)
p_load(here)
p_load(tictoc)
p_load(patchwork)
p_load(janitor)
p_load(glue)

# Próprios
p_load(cid10)
p_load(msrpack)

# Leitura
p_load(openxlsx)
p_load(readxl)
p_load(WriteXLS)
p_load(ggthemes)
p_load(googlesheets4)
p_load(vroom)

# Transformação e análise de dados
p_load(caret)
p_load(zoo)
p_load(tidyverse)
p_load(lubridate)

# Ajustes locais ----------------------------------------------------------

set_key(api_key = "tfgapuFbaa8rSY0QS_dbZj9d8qmdeKiXFHl2L39b-FY") # Api HERE
Sys.setenv(TZ="America/Recife")
options(tz="America/Recife")
Sys.getenv("TZ")
options(scipen = 999999)
Sys.setlocale("LC_TIME", "pt_BR")




# Carregamentos iniciais --------------------------------------------------
# Arquivos gerados pelo script moniramento.r
# 


internados <- read_rds(file = "../bin/internados.rds")
op_inverno <- read_rds(file = "../bin/op_inverno.rds")
hospitais_poa <- read_rds(file = "/Users/marciorodrigues/Dropbox/Coding/R/data/cnes/bin/hospitais_poa.rds")



```

-----------------------------------------------------------------------


Column {data-width=650}
-----------------------------------------------------------------------



### Pacientes internados no momento

```{r}

internados %>% 
  select(datahorainternacao, protocologerint, tipoleito, carater, idade, sexo, executante) %>% 
  mutate(
    datahorainternacao = date(datahorainternacao)
  ) %>% 
reactable(
  groupBy = "executante", 
  columns = list(
    executante = colDef(name = "Hospital Executante", minWidth = 600),
    datahorainternacao = colDef(name = "Data da Internação", minWidth = 200),
    protocologerint = colDef(name = "gerint", minWidth = 200),
    datahorainternacao = colDef(name = "Data da Internação", minWidth = 100),
    datahorainternacao = colDef(name = "Data da Internação", minWidth = 100),
    datahorainternacao = colDef(name = "Data da Internação", minWidth = 100)
  )
  
)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}

int_hosp <- left_join(internados, hospitais_poa, by = c("executante" = "no_fantasia")) %>% 
  select(executante, nu_latitude, nu_longitude) %>% 
  group_by(executante, nu_latitude, nu_longitude) %>% 
  tally() %>% 
  mutate(
    legenda = glue(.sep = "<br/>", "<b>{executante}</b>", "Quantidade de pacientes: {n} <br/>")
    )

leaflet(data = int_hosp) %>% 
  addTiles() %>% 
  addCircleMarkers(
    lng = ~nu_longitude, 
    lat = ~nu_latitude, 
    radius = ~log(n, base = 1.5), 
    popup = ~as.character(legenda),
    label =~as.character(executante) 
    ) 


```

### Chart C

```{r}

```

